<!doctype html>
<html lang="he" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>FC67 ULTIMATE TEAM</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;800&display=swap');
        
        :root {
            --gold: #fcd34d;
            --gold-dark: #b45309;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { box-sizing: border-box; font-family: 'Assistant', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b, var(--bg));
            color: #f1f5f9; 
            padding-bottom: 90px; 
            min-height: 100vh;
        }

        /* --- HEADER --- */
        .header { 
            background: rgba(15, 23, 42, 0.95);
            padding: 12px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #334155;
            position: sticky; top: 0; z-index: 2000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .header h1 { margin: 0; font-size: 1.2rem; color: var(--gold); text-transform: uppercase; letter-spacing: 1px; }
        .currency { background: #334155; padding: 5px 12px; border-radius: 20px; font-weight: bold; display: flex; align-items: center; gap: 6px; font-size: 0.9rem; border: 1px solid #475569; }

        /* --- NAV --- */
        .nav-bar { 
            display: flex; background: #1e293b; border-top: 1px solid #334155;
            position: fixed; bottom: 0; width: 100%; z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-btn { 
            flex: 1; padding: 10px; border: none; background: none; 
            color: #64748b; font-size: 0.7rem; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-btn i { font-size: 1.4rem; }
        .nav-btn.active { color: var(--gold); background: rgba(255,255,255,0.05); }

        /* --- TABS --- */
        .tab { display: none; padding: 15px; max-width: 600px; margin: 0 auto; animation: fadeUp 0.3s ease; }
        .tab.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS --- */
        .player-card {
            width: 80px; height: 110px;
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            border: 2px solid #64748b;
            border-radius: 8px; position: relative;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; overflow: hidden; transition: transform 0.1s;
        }
        .player-card:active { transform: scale(0.95); }
        
        /* Gold Card */
        .player-card[data-rating="gold"] {
            background: linear-gradient(135deg, #fcd34d 0%, #d97706 100%);
            border-color: #f59e0b;
        }
        /* Elite Card (88+) */
        .player-card.elite {
            background: linear-gradient(135deg, #000 0%, #451a03 100%);
            border: 2px solid var(--gold);
            box-shadow: 0 0 15px rgba(252, 211, 77, 0.5);
        }
        .player-card.elite::before {
            content:''; position: absolute; inset:0; 
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 2s infinite;
        }
        @keyframes shine { 0% {transform: translateX(-100%);} 100% {transform: translateX(100%);} }

        .card-rating { position: absolute; top: 2px; left: 5px; font-weight: 900; font-size: 1rem; color: #1e293b; z-index: 2; }
        .elite .card-rating { color: #fcd34d; }
        .card-pos { position: absolute; top: 18px; left: 5px; font-size: 0.7rem; font-weight: bold; color: #334155; z-index: 2; }
        .elite .card-pos { color: #ccc; }
        .card-img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-top: 15px; border: 2px solid rgba(255,255,255,0.2); background:#000; z-index: 1; }
        .card-name { font-size: 0.7rem; width: 100%; text-align: center; background: rgba(0,0,0,0.6); color: #fff; padding: 2px 0; margin-top: auto; font-weight: bold; z-index: 2; white-space: nowrap; overflow: hidden; }

        /* --- PITCH --- */
        .pitch {
            background: #064e3b;
            background-image: linear-gradient(transparent 95%, rgba(255,255,255,0.2) 95%), linear-gradient(90deg, transparent 95%, rgba(255,255,255,0.2) 95%);
            background-size: 20px 20px;
            border: 3px solid #34d399; border-radius: 12px;
            padding: 20px 0; min-height: 450px;
            display: flex; flex-direction: column; justify-content: space-around;
            box-shadow: inset 0 0 40px #022c22;
        }
        .pitch-row { display: flex; justify-content: center; gap: 15px; }
        .empty-slot {
            width: 80px; height: 110px;
            border: 2px dashed rgba(255,255,255,0.3); border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            color: rgba(255,255,255,0.3); font-weight: bold;
        }

        /* --- PACK OPENING --- */
        #pack-overlay {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: none; align-items: center; justify-content: center; flex-direction: column;
        }
        .pack {
            width: 200px; height: 300px;
            background: linear-gradient(45deg, #b45309, #fbbf24);
            border: 4px solid #fff; border-radius: 16px;
            box-shadow: 0 0 50px var(--gold);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 4rem;
        }
        .pack.shaking { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }

        /* --- MARKET & GRID --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 10px; padding-bottom: 20px; }
        .market-item { background: #1e293b; padding: 10px; border-radius: 10px; border: 1px solid #334155; text-align: center; display: flex; flex-direction: column; align-items: center; }
        
        .btn { border: none; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; margin-top: 5px; font-size: 0.9rem; }
        .btn-green { background: var(--success); color: #064e3b; }
        .btn-red { background: var(--danger); color: white; }
        .btn-blue { background: var(--accent); color: #0f172a; }
        .btn-gold { background: var(--gold); color: #451a03; }

        /* --- MODAL --- */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 4000; display: none; align-items: center; justify-content: center; }
        .modal-content { background: #1e293b; padding: 20px; border-radius: 16px; width: 90%; max-width: 320px; text-align: center; border: 1px solid #475569; }

    </style>
</head>
<body>

<div class="header">
    <div class="currency">
        <span>âš½</span> <span id="club-name">My Club</span>
    </div>
    <div style="display:flex; gap:10px;">
        <div class="currency" style="color:#a855f7;">â­ <span id="lvl-display">1</span></div>
        <div class="currency" style="color:var(--gold); border-color:var(--gold);">ğŸ’° <span id="coins-display">0</span></div>
    </div>
</div>

<div id="tab-club" class="tab active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h2 style="margin:0;">×”×”×¨×›×‘ ×©×œ×™</h2>
        <div style="background:#0f172a; padding:5px 10px; border-radius:8px; font-size:0.8rem; border:1px solid #333;">
            ×›×™××™×”: <span id="chem-display" style="color:var(--success);">0</span>%
        </div>
    </div>

    <div class="pitch" id="pitch-container">
        </div>
    
    <h3 style="margin-top:20px;">×¡×¤×¡×œ</h3>
    <div id="bench-container" style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px; min-height: 120px;">
        </div>
</div>

<div id="tab-market" class="tab">
    <div style="background:#1e293b; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #334155;">
        <h2 style="margin:0; color:var(--success);">×©×•×§ ×”×”×¢×‘×¨×•×ª ğŸŒ</h2>
        <p style="font-size:0.8rem; color:#94a3b8; margin:5px 0;">×”×©×•×§ ××ª×¨×¢× ×Ÿ ×›×œ 30 ×©× ×™×•×ª ×‘××•×¤×Ÿ ××•×˜×•××˜×™.</p>
    </div>
    <div id="market-grid" class="grid">
        </div>
</div>

<div id="tab-store" class="tab">
    <h2 style="text-align:center;">×—× ×•×ª ×—×‘×™×œ×•×ª ğŸ›’</h2>
    <div class="grid" style="grid-template-columns: 1fr 1fr; margin-top:20px;">
        <div class="market-item">
            <div style="font-size:3rem;">ğŸ“¦</div>
            <h3>×—×‘×™×œ×ª ××¨×“</h3>
            <p style="font-size:0.8rem; color:#94a3b8;">×©×—×§× ×™× 75+</p>
            <button class="btn btn-blue" onclick="buyPack('basic')">300 ğŸ’°</button>
        </div>
        <div class="market-item" style="border-color:var(--gold); background: linear-gradient(135deg, #451a03, #172554);">
            <div style="font-size:3rem;">ğŸŒŸ</div>
            <h3 style="color:var(--gold);">×—×‘×™×œ×ª ××•×œ×˜×™××™×™×˜</h3>
            <p style="font-size:0.8rem; color:#cbd5e1;">×©×—×§× ×™× 84-99</p>
            <button class="btn btn-gold" onclick="buyPack('premium')">1000 ğŸ’°</button>
        </div>
    </div>
    <div style="margin-top:20px; background:#1e293b; padding:15px; border-radius:12px; text-align:center;">
        <h3>×—×¡×¨ ×›×¡×£?</h3>
        <button class="btn btn-green" onclick="watchAd()">×¦×¤×” ×‘×¤×¨×¡×•××ª (+100 ğŸ’°)</button>
    </div>
</div>

<div id="tab-collection" class="tab">
    <h3>×”×©×—×§× ×™× ×©×œ×™ (<span id="coll-count">0</span>)</h3>
    <div id="collection-grid" class="grid"></div>
</div>

<div class="nav-bar">
    <button class="nav-btn active" onclick="switchTab('club', this)"><span>âš½</span>××•×¢×“×•×Ÿ</button>
    <button class="nav-btn" onclick="switchTab('market', this)"><span>ğŸŒ</span>×©×•×§</button>
    <button class="nav-btn" onclick="switchTab('store', this)"><span>ğŸ›’</span>×—× ×•×ª</button>
    <button class="nav-btn" onclick="switchTab('collection', this)"><span>ğŸ“š</span>××•×¡×£</button>
</div>

<div id="pack-overlay">
    <div id="pack-obj" class="pack" onclick="openPackAnim()">
        ğŸ§§
    </div>
    <div id="pack-reveal" style="display:none; text-align:center;">
        <div id="new-card-container" style="transform: scale(1.5); margin-bottom: 50px;"></div>
        <h1 id="walkout-text" style="color:var(--gold); display:none; animation: pulse 0.5s infinite;">WALKOUT!!!</h1>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="btn btn-green" style="width:120px;" onclick="storeNewCard()">×©××•×¨ ×‘××•×¢×“×•×Ÿ</button>
            <button class="btn btn-red" style="width:120px;" id="pack-qs-btn" onclick="quickSellNewCard()">Quick Sell</button>
        </div>
    </div>
</div>

<div id="action-modal" class="modal-bg" onclick="closeModal(event)">
    <div class="modal-content">
        <h3 id="modal-title">××¤×©×¨×•×™×•×ª ×©×—×§×Ÿ</h3>
        <div id="modal-actions"></div>
        <button class="btn btn-blue" style="margin-top:10px;" onclick="document.getElementById('action-modal').style.display='none'">×‘×™×˜×•×œ</button>
    </div>
</div>

<script>
    // --- DATA ---
    const PLAYERS_DB = [
        {name: "×›×•×©×™", pos: "FWD", rating: 99, img: "https://media.discordapp.net/attachments/1451328561226190929/1451339056314323075/31.png?ex=6945d053&is=69447ed3&hm=66d396730758c8df38e124c4776bc567ac3450a81c395b6d819989d0eb9dab25&=&format=webp&quality=lossless"},
        {name: "×”×‘×™×’×•×Ÿ", pos: "GK", rating: 91, img: "https://media.discordapp.net/attachments/1406648962458583241/1451205336177447095/WhatsApp_Image_2025-12-18_at_12.56.32_4.jpeg?ex=694553ca&is=6944024a&hm=d7bde1489a098c2b7d54403feed38fcf330e50bb43b35988c3d305ea058d1047&=&format=webp"},
        {name: "××¨", pos: "FWD", rating: 91, img: "https://media.discordapp.net/attachments/1451328561226190929/1451328868509286540/2025-12-08_140832.png?ex=6945c6d6&is=69447556&hm=780d4d9f15f33e8190e07422646c6a1412a8edee99a74c1107fba0abef3422cd&=&format=webp&quality=lossless"},
        {name: "××™×¨", pos: "GK", rating: 90, img: "https://media.discordapp.net/attachments/1406648962458583241/1451246090438443038/WhatsApp_Image_2025-12-18_at_12.56.32_9.jpeg?ex=694579be&is=6944283e&hm=dc12f06068dcbf4fcdd30f5bc9a638c9680f66e26040878e36b1c011c2580d5e&=&format=webp"},
        {name: "×©×¨×§", pos: "FWD", rating: 89, img: "https://media.discordapp.net/attachments/1406648962458583241/1451205099996053544/WhatsApp_Image_2025-12-18_at_12.56.32_2.jpeg?ex=69455391&is=69440211&hm=c6f342319b4cf7dd202ed669dd6c1bedca125616bd11d86555867a350147d586&=&format=webp"},
        {name: "×‘×•×", pos: "FWD", rating: 89, img: "https://media.discordapp.net/attachments/1406648962458583241/1451246385209938000/WhatsApp_Image_2025-12-18_at_12.56.32_10.jpeg?ex=69457a05&is=69442885&hm=2df987073db7e8828f3bf830b4090b03ea5bc72e1af70ded38a4946e1e69f189&=&format=webp"},
        {name: "×§×¨×™×¡×˜×œ", pos: "MID", rating: 89, img: "https://media.discordapp.net/attachments/1451328561226190929/1451337301178449940/71ezEUPrzPL._AC_UF8941000_QL80_.jpg?ex=6945ceb1&is=69447d31&hm=d5cc4385a9a5aa417c976669dd4329c2969580209ea4da6caf4bec1cd7b7f264&=&format=webp&width=770&height=960"},
        {name: "×•×•×™× ×™", pos: "MID", rating: 88, img: "https://media.discordapp.net/attachments/1451328561226190929/1451335757045170378/2025-12-19_001003.png?ex=6945cd40&is=69447bc0&hm=2c7fcc4d7ba2af243696f64f9d92d2d592f4878033e2d7dc3007e8ea7086157b&=&format=webp&quality=lossless"},
        {name: "×™×•× ×ª×Ÿ", pos: "MID", rating: 88, img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ8vfEEelp7ot4nSWqrl3sSabqDGdiNrfHHkVjx2kqURccMwCMBbi8kSqfVHlmnTkwMgOczQgQ40RUqtIaw1sx6KVYo79keTIutrmPF9Q&s=10"},
        {name: "××•×¨", pos: "FWD", rating: 88, img: "https://media.discordapp.net/attachments/1451328561226190929/1451336872570912868/VRFS__2025-12-18_18-35-06.jpg?ex=6945ce4a&is=69447cca&hm=efd9c19eb03d8ff2faff6c6a784caa2deec7c6e4ddd58eeb9e8ca8359492ffef&=&format=webp"},
        {name: "×“×•×“", pos: "DEF", rating: 87, img: "https://media.discordapp.net/attachments/1451328561226190929/1451335794391519362/F145A669-C121-481E-B783-A929A4CD439C.png?ex=6945cd49&is=69447bc9&hm=71191ea135eac1845052f68445f1ecc4336cda64e085f43497ad56d9b9f1a7e6&=&format=webp&quality=lossless&width=640&height=960"},
        {name: "×˜×•×™", pos: "FWD", rating: 87, img: "https://media.discordapp.net/attachments/1451328561226190929/1451336172772261888/2024-07-05_180537.png?ex=6945cda4&is=69447c24&hm=476cc10a15cff4b0dccc5b9d24c65192b82a4ed518e2d18ea69f61135f5800ad&=&format=webp&quality=lossless"},
        {name: "×’×‘×™× ×”", pos: "MID", rating: 87, img: "https://media.discordapp.net/attachments/1451328561226190929/1451336082552651776/VRFS__2025-12-18_18-35-31.jpg?ex=6945cd8e&is=69447c0e&hm=b23825cfe2af008d946eea0c607562b4fd0b6377b3f4167f731e617e30a1f67c&=&format=webp"},
        {name: "×©×‘×•×ª×”", pos: "MID", rating: 86, img: "https://media.discordapp.net/attachments/1451328561226190929/1451336624318320691/2025-12-19_001354.png?ex=6945ce0f&is=69447c8f&hm=627bec49930ba5e8d88d9b6e8974327936ba5e8ed3ccd6084dc4f5420f20fbe6&=&format=webp&quality=lossless"},
        {name: "×™××™×", pos: "FWD", rating: 86, img: "https://media.discordapp.net/attachments/1406648962458583241/1451327661803831488/VRFS__2025-12-18_18-27-18.jpg?ex=6945c5b6&is=69447436&hm=7d74b821c4941f765db80ad8c1995eef2bb99784db86858d5c5932c4b3d986f0&=&format=webp"},
        {name: "×“×¨×•×¤×™×§×¡", pos: "FWD", rating: 85, img: "https://media.discordapp.net/attachments/1451328561226190929/1451335844064657531/2025-12-19_001025.png?ex=6945cd55&is=69447bd5&hm=857282b63386835b860c775eb4920a0258fade2497bc9e7924395d5071285da3&=&format=webp&quality=lossless"},
        {name: "×¢×™×œ××™", pos: "DEF", rating: 85, img: "https://media.discordapp.net/attachments/1451328561226190929/1451337583459041330/2025-04-26_211815.png?ex=6945cef4&is=69447d74&hm=df4b886341747941d96ff1071387f6869c62548219566e76653467df881324c3&=&format=webp&quality=lossless"},
        {name: "×’×•×œ×“×™", pos: "MID", rating: 84, img: "https://media.discordapp.net/attachments/1451328561226190929/1451337038656966817/gold-1920w.webp?ex=6945ce72&is=69447cf2&hm=dfc3efac8e6073074fbe6f7a19c7badf1751e8acc33b55f77aa6e3e1ab38816d&=&format=webp"},
        {name: "××§×¡×¤×¨×™×Ÿ", pos: "MID", rating: 84, img: "https://media.discordapp.net/attachments/1406648962458583241/1451326969970032650/VRFS__2025-12-18_18-37-35.jpg?ex=6945c511&is=69447391&hm=51b074b852cc68c4741c2a4ee92cd2627e01cc9f7d70e5795e17ab9ff9893e01&=&format=webp"},
        {name: "××™×ª××¨", pos: "MID", rating: 81, img: "https://media.discordapp.net/attachments/1406648962458583241/1451327221640855643/VRFS__2025-12-18_18-27-10.jpg?ex=6945c54d&is=694473cd&hm=5f572350ff5df69a6f47299b059499482d959a853c6161f0bd00e4221f4a9903&=&format=webp"},
        {name: "×˜×œ×§×¨", pos: "DEF", rating: 80, img: "https://media.discordapp.net/attachments/1406648962458583241/1451245787190263940/WhatsApp_Image_2025-12-18_at_12.56.32_7.jpeg?ex=69457976&is=694427f6&hm=eda130bd359c11e59843bbd06c05472bb2515e1001c49bd9821a24fea6365107&=&format=webp"},
        {name: "×‘×•×‘×•", pos: "DEF", rating: 77, img: "https://taoos.co.il/product/%D7%90%D7%99%D7%A9-%D7%A9%D7%9C%D7%92-%D7%9E%D7%97%D7%9C%D7%99%D7%A7-%D7%A2%D7%9C-%D7%A7%D7%A8%D7%97-%D7%9B%D7%95%D7%91%D7%A2-%D7%9B%D7%97%D7%95%D7%9C/"},
        {name: "××™×›××œ", pos: "MID", rating: 77, img: "https://api.dicebear.com/7.x/avataaars/svg?seed=Michael"}
    ];
    const POSITIONS = ["GK", "DEF", "MID", "FWD"];

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDAyQfRIPiJO2pENF4AF9LDWTjyLeOrQNY",
        authDomain: "fc67-3de49.firebaseapp.com",
        databaseURL: "https://fc67-3de49-default-rtdb.firebaseio.com/",
        projectId: "fc67-3de49",
        storageBucket: "fc67-3de49.firebasestorage.app",
        messagingSenderId: "484648478424",
        appId: "1:484648478424:web:dfd4899b7477cc83f699ad"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // --- STATE ---
    let user = {
        coins: 1500,
        lvl: 1,
        lineup: [],
        bench: [],
        collection: []
    };
    let myId = null;
    let tempPackCard = null;
    let marketInterval = null;
    let marketItems = [];

    // --- INIT ---
    auth.signInAnonymously();
    auth.onAuthStateChanged(u => {
        if(u) {
            myId = u.uid;
            db.ref('users/' + myId).on('value', snap => {
                const val = snap.val();
                if(val) {
                    user = val;
                    if(!user.lineup) user.lineup = [];
                    if(!user.bench) user.bench = [];
                    if(!user.collection) user.collection = [];
                } else {
                    // Starter Pack
                    for(let i=0; i<5; i++) user.collection.push(createRandomPlayer(75, 80));
                    saveUser();
                }
                updateUI();
            });
        }
    });

    function saveUser() { db.ref('users/' + myId).set(user); }

    // --- GENERATORS ---
    function createRandomPlayer(min, max) {
        // 30% chance from DB
        if(Math.random() < 0.3) {
            const potential = PLAYERS_DB.filter(p => p.rating >= min && p.rating <= max);
            if(potential.length) {
                const p = potential[Math.floor(Math.random()*potential.length)];
                return {...p, uid: Date.now()+Math.random().toString()};
            }
        }
        // Generic
        const name = GENERIC_NAMES[Math.floor(Math.random()*GENERIC_NAMES.length)];
        const rating = Math.floor(Math.random()*(max-min+1))+min;
        const pos = POSITIONS[Math.floor(Math.random()*POSITIONS.length)];
        const img = `https://api.dicebear.com/7.x/avataaars/svg?seed=${name+rating}&backgroundColor=e5e7eb`;
        return {name, rating, pos, img, uid: Date.now()+Math.random().toString()};
    }

    // --- UI RENDER ---
    function updateUI() {
        document.getElementById('coins-display').innerText = user.coins;
        document.getElementById('lvl-display').innerText = user.lvl;

        // Lineup (1 GK, 2 DEF, 2 MID, 1 FWD)
        const pitch = document.getElementById('pitch-container');
        pitch.innerHTML = '';
        const formation = [
            {pos:'FWD', count:1},
            {pos:'MID', count:2},
            {pos:'DEF', count:2},
            {pos:'GK', count:1}
        ];

        formation.forEach(row => {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'pitch-row';
            const playersInPos = user.lineup.filter(p => p.pos === row.pos);
            for(let i=0; i<row.count; i++) {
                if(playersInPos[i]) {
                    rowDiv.innerHTML += renderCard(playersInPos[i], `handleLineupClick('${playersInPos[i].uid}')`);
                } else {
                    rowDiv.innerHTML += `<div class="empty-slot">${row.pos}</div>`;
                }
            }
            pitch.appendChild(rowDiv);
        });

        // Bench
        document.getElementById('bench-container').innerHTML = user.bench.map(p => renderCard(p, `handleBenchClick('${p.uid}')`)).join('');
        
        // Collection
        document.getElementById('coll-count').innerText = user.collection.length;
        document.getElementById('collection-grid').innerHTML = user.collection.map(p => renderCard(p, `handleCollectionClick('${p.uid}')`)).join('');
        
        // Chemistry
        const chem = Math.round((user.lineup.length / 6) * 100);
        document.getElementById('chem-display').innerText = chem;
    }

    function renderCard(p, onclick) {
        const isElite = p.rating >= 88;
        const isGold = p.rating >= 80 && p.rating < 88;
        return `
        <div class="player-card ${isElite?'elite':''} ${p.uid === 'market' ? 'market-preview' : ''}" 
             data-rating="${isGold?'gold':''}" onclick="${onclick}">
            <div class="card-rating">${p.rating}</div>
            <div class="card-pos">${p.pos}</div>
            <img src="${p.img}" class="card-img">
            <div class="card-name">${p.name}</div>
        </div>`;
    }

    // --- INTERACTION HANDLERS (MODAL) ---
    let selectedPlayerUid = null;
    let context = null; // 'lineup', 'bench', 'coll'

    function handleLineupClick(uid) {
        selectedPlayerUid = uid; context = 'lineup';
        showModal("×©×—×§×Ÿ ×”×¨×›×‘", `<button class="btn btn-blue" onclick="moveLineupToBench()">â¬‡ï¸ ×”×•×¨×“ ×œ×¡×¤×¡×œ</button>`);
    }

    function handleBenchClick(uid) {
        selectedPlayerUid = uid; context = 'bench';
        const p = user.bench.find(x => x.uid === uid);
        const sellPrice = p.rating * 10;
        showModal("×©×—×§×Ÿ ×¡×¤×¡×œ", `
            <button class="btn btn-green" onclick="moveBenchToLineup()">â¬†ï¸ ×”×¢×œ×” ×œ×”×¨×›×‘</button>
            <button class="btn btn-red" onclick="quickSellFromBench()">ğŸ’° ××›×™×¨×” ××”×™×¨×” (${sellPrice})</button>
        `);
    }

    function handleCollectionClick(uid) {
        selectedPlayerUid = uid; context = 'coll';
        const p = user.collection.find(x => x.uid === uid);
        const sellPrice = p.rating * 10;
        showModal("×©×—×§×Ÿ ××•×¡×£", `
            <button class="btn btn-blue" onclick="moveCollectionToBench()">×”×¢×‘×¨ ×œ×¡×’×œ</button>
            <button class="btn btn-red" onclick="quickSellFromCollection()">ğŸ’° ××›×™×¨×” ××”×™×¨×” (${sellPrice})</button>
        `);
    }

    function showModal(title, html) {
        document.getElementById('modal-title').innerText = title;
        document.getElementById('modal-actions').innerHTML = html;
        document.getElementById('action-modal').style.display = 'flex';
    }

    function closeModal(e) {
        if(e.target.id === 'action-modal') document.getElementById('action-modal').style.display = 'none';
    }

    // --- LOGIC: MOVES ---
    function moveLineupToBench() {
        const idx = user.lineup.findIndex(p => p.uid === selectedPlayerUid);
        const player = user.lineup[idx];
        if(user.bench.length >= 7) {
            user.collection.push(player); // Overflow to collection
        } else {
            user.bench.push(player);
        }
        user.lineup.splice(idx, 1);
        saveUser();
        document.getElementById('action-modal').style.display = 'none';
    }

    function moveBenchToLineup() {
        const idx = user.bench.findIndex(p => p.uid === selectedPlayerUid);
        const player = user.bench[idx];
        
        // Check pos limit
        const limit = {GK:1, DEF:2, MID:2, FWD:1};
        const currentCount = user.lineup.filter(x => x.pos === player.pos).length;
        
        if(currentCount < limit[player.pos]) {
            user.lineup.push(player);
            user.bench.splice(idx, 1);
            saveUser();
        } else {
            alert("××™×Ÿ ××§×•× ×‘×¢××“×” ×–×•! ×”×•×¨×“ ×©×—×§×Ÿ ×§×•×“×.");
        }
        document.getElementById('action-modal').style.display = 'none';
    }

    function moveCollectionToBench() {
        const idx = user.collection.findIndex(p => p.uid === selectedPlayerUid);
        if(user.bench.length >= 7) return alert("×”×¡×¤×¡×œ ××œ×!");
        user.bench.push(user.collection[idx]);
        user.collection.splice(idx, 1);
        saveUser();
        document.getElementById('action-modal').style.display = 'none';
    }

    function quickSellFromCollection() {
        const idx = user.collection.findIndex(p => p.uid === selectedPlayerUid);
        const price = user.collection[idx].rating * 10;
        user.coins += price;
        user.collection.splice(idx, 1);
        saveUser();
        document.getElementById('action-modal').style.display = 'none';
    }

    function quickSellFromBench() {
        const idx = user.bench.findIndex(p => p.uid === selectedPlayerUid);
        const price = user.bench[idx].rating * 10;
        user.coins += price;
        user.bench.splice(idx, 1);
        saveUser();
        document.getElementById('action-modal').style.display = 'none';
    }

    // --- PACK OPENING (ANIMATION + QS) ---
    function buyPack(type) {
        const price = type === 'basic' ? 300 : 1000;
        if(user.coins < price) return alert("××™×Ÿ ××¡×¤×™×§ ×›×¡×£!");
        user.coins -= price;
        saveUser();

        // Prepare Card
        tempPackCard = type === 'basic' ? createRandomPlayer(75, 85) : createRandomPlayer(84, 99);
        const qsPrice = tempPackCard.rating * 10;
        document.getElementById('pack-qs-btn').innerText = `Quick Sell (${qsPrice})`;

        // Reset UI
        document.getElementById('pack-overlay').style.display = 'flex';
        document.getElementById('pack-obj').style.display = 'flex';
        document.getElementById('pack-obj').classList.remove('shaking');
        document.getElementById('pack-reveal').style.display = 'none';
        document.getElementById('walkout-text').style.display = 'none';
    }

    function openPackAnim() {
        const pack = document.getElementById('pack-obj');
        pack.classList.add('shaking');

        setTimeout(() => {
            pack.style.display = 'none';
            document.getElementById('pack-reveal').style.display = 'block';
            
            // Render Big Card
            const isElite = tempPackCard.rating >= 88;
            document.getElementById('new-card-container').innerHTML = renderCard(tempPackCard, '');
            
            // Effects
            if(isElite) {
                document.getElementById('walkout-text').style.display = 'block';
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#fcd34d', '#ffffff'] });
            } else {
                confetti({ particleCount: 50, spread: 50, origin: { y: 0.6 } });
            }

        }, 1200);
    }

    function storeNewCard() {
        user.collection.push(tempPackCard);
        saveUser();
        document.getElementById('pack-overlay').style.display = 'none';
    }

    function quickSellNewCard() {
        user.coins += tempPackCard.rating * 10;
        saveUser();
        document.getElementById('pack-overlay').style.display = 'none';
    }

    // --- TRANSFER MARKET (SIMULATION) ---
    function refreshMarket() {
        marketItems = [];
        for(let i=0; i<6; i++) {
            const p = createRandomPlayer(75, 92);
            // Market Price logic (random slightly higher than quicksell)
            const price = (p.rating * 10) + Math.floor(Math.random() * 200);
            marketItems.push({player: p, price: price, id: i});
        }
        renderMarket();
    }

    function renderMarket() {
        const grid = document.getElementById('market-grid');
        grid.innerHTML = marketItems.map(item => `
            <div class="market-item">
                ${renderCard(item.player, '')}
                <div style="font-size:0.9rem; font-weight:bold; color:var(--gold); margin:5px 0;">${item.price} ğŸ’°</div>
                <button class="btn btn-green" onclick="buyFromMarket(${item.id})">×§× ×”</button>
            </div>
        `).join('');
    }

    function buyFromMarket(id) {
        const item = marketItems.find(x => x.id === id);
        if(!item) return;
        
        if(user.coins >= item.price) {
            user.coins -= item.price;
            user.collection.push({...item.player, uid: Date.now()+Math.random().toString()});
            saveUser();
            alert(`×§× ×™×ª ××ª ${item.player.name}!`);
            
            // Remove from market visually
            marketItems = marketItems.filter(x => x.id !== id);
            renderMarket();
        } else {
            alert("××™×Ÿ ×œ×š ××¡×¤×™×§ ××˜×‘×¢×•×ª!");
        }
    }

    // Auto refresh market every 30s
    setInterval(refreshMarket, 30000);
    // Initial load
    setTimeout(refreshMarket, 1000);

    // --- UTILS ---
    function switchTab(id, btn) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById('tab-' + id).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function watchAd() {
        user.coins += 100;
        saveUser();
        alert("×ª×•×“×” ×©×¦×¤×™×ª! ×§×™×‘×œ×ª 100 ××˜×‘×¢×•×ª.");
    }
</script>
</body>
</html>
